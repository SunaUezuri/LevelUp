DROP TABLE TB_LEVELUP_TASK_COMPLETIONS CASCADE CONSTRAINTS;
DROP TABLE TB_LEVELUP_TASK_ASSIGNMENTS CASCADE CONSTRAINTS;
DROP TABLE TB_LEVELUP_TASKS CASCADE CONSTRAINTS;
DROP TABLE TB_LEVELUP_AUDIT_LOGS CASCADE CONSTRAINTS;

CREATE TABLE TB_LEVELUP_TASKS (
    TASK_ID         NUMBER(10)      GENERATED BY DEFAULT ON NULL AS IDENTITY,
    TITLE           VARCHAR2(255)   CONSTRAINT NN_TASKS_TITLE NOT NULL,
    DESCRIPTION     VARCHAR2(1000),
    POINTS_VALUE    NUMBER(5)       CONSTRAINT NN_TASKS_POINTS NOT NULL,
    TASK_TYPE       VARCHAR2(20)    CONSTRAINT NN_TASKS_TYPE NOT NULL,
    CREATED_AT      DATE            DEFAULT SYSDATE CONSTRAINT NN_TASKS_CREATED_AT NOT NULL,
    UPDATED_AT      DATE,
    IS_ACTIVE       CHAR(1)         DEFAULT 'Y' CONSTRAINT NN_TASKS_ACTIVE NOT NULL,

    CONSTRAINT PK_TASKS PRIMARY KEY (TASK_ID),
    CONSTRAINT CK_TASKS_POINTS_POSITIVE CHECK (POINTS_VALUE > 0),
    CONSTRAINT CK_TASKS_TYPE CHECK (TASK_TYPE IN ('WORK', 'SOCIAL', 'WELLNESS')),
    CONSTRAINT CK_TASKS_ACTIVE CHECK (IS_ACTIVE IN ('Y','N'))
);

CREATE TABLE TB_LEVELUP_TASK_ASSIGNMENTS (
    ASSIGNMENT_ID   NUMBER(10)      GENERATED BY DEFAULT ON NULL AS IDENTITY,
    TASK_ID         NUMBER(10)      CONSTRAINT NN_ASSIGN_TASK NOT NULL,
    USER_ID         NUMBER(10),
    TEAM_ID         NUMBER(10),
    PERIOD_START    DATE            CONSTRAINT NN_ASSIGN_PERIOD_START NOT NULL,
    PERIOD_END      DATE            CONSTRAINT NN_ASSIGN_PERIOD_END NOT NULL,
    IS_MANDATORY    CHAR(1)         DEFAULT 'N' CONSTRAINT NN_ASSIGN_MANDATORY NOT NULL,

    CONSTRAINT PK_ASSIGNMENTS PRIMARY KEY (ASSIGNMENT_ID),
    CONSTRAINT FK_ASSIGN_TASK FOREIGN KEY (TASK_ID) REFERENCES TB_LEVELUP_TASKS (TASK_ID),
    CONSTRAINT FK_ASSIGN_USER FOREIGN KEY (USER_ID) REFERENCES TB_LEVELUP_USERS (USER_ID),
    CONSTRAINT FK_ASSIGN_TEAM FOREIGN KEY (TEAM_ID) REFERENCES TB_LEVELUP_TEAMS (TEAM_ID),

    CONSTRAINT CK_ASSIGN_USER_OR_TEAM CHECK (
        (USER_ID IS NOT NULL AND TEAM_ID IS NULL) OR
        (USER_ID IS NULL AND TEAM_ID IS NOT NULL)
    ),
    CONSTRAINT CK_ASSIGN_MANDATORY CHECK (IS_MANDATORY IN ('Y','N'))
);

CREATE TABLE TB_LEVELUP_TASK_COMPLETIONS (
    COMPLETION_ID   NUMBER(10)      GENERATED BY DEFAULT ON NULL AS IDENTITY,
    USER_ID         NUMBER(10)      CONSTRAINT NN_COMPLETIONS_USER NOT NULL,
    TASK_ID         NUMBER(10)      CONSTRAINT NN_COMPLETIONS_TASK NOT NULL,
    COMPLETED_AT    DATE            DEFAULT SYSDATE CONSTRAINT NN_COMPLETIONS_DATE NOT NULL,

    CONSTRAINT PK_COMPLETIONS PRIMARY KEY (COMPLETION_ID),
    CONSTRAINT FK_COMPLETIONS_USER FOREIGN KEY (USER_ID) REFERENCES TB_LEVELUP_USERS (USER_ID),
    CONSTRAINT FK_COMPLETIONS_TASK FOREIGN KEY (TASK_ID) REFERENCES TB_LEVELUP_TASKS (TASK_ID),

    CONSTRAINT UK_COMPLETIONS_USER_TASK UNIQUE (USER_ID, TASK_ID)
);

CREATE TABLE TB_LEVELUP_AUDIT_LOGS (
    LOG_ID            NUMBER(19)      GENERATED BY DEFAULT ON NULL AS IDENTITY,
    TABLE_NAME        VARCHAR2(100)   CONSTRAINT NN_AUDIT_TABLE_NAME NOT NULL,
    OPERATION_TYPE    VARCHAR2(10)    CONSTRAINT NN_AUDIT_OP_TYPE NOT NULL,
    RECORD_PK_VALUE   VARCHAR2(255),
    CHANGED_BY        VARCHAR2(255)   DEFAULT USER,
    CHANGED_AT        DATE            DEFAULT SYSDATE,

    CONSTRAINT PK_AUDIT_LOGS PRIMARY KEY (LOG_ID),
    CONSTRAINT CK_AUDIT_OP_TYPE CHECK (OPERATION_TYPE IN ('INSERT', 'UPDATE', 'DELETE'))
);

CREATE OR REPLACE PACKAGE PKG_LEVELUP_APP AS

    
    E_USER_NOT_FOUND   EXCEPTION;
    E_NO_DATA_FOR_JSON EXCEPTION;
    E_INVALID_EMAIL    EXCEPTION;

    PROCEDURE PR_CREATE_TEAM(
        P_TEAM_NAME IN TB_LEVELUP_TEAMS.TEAM_NAME%TYPE,
        P_TEAM_ID   OUT TB_LEVELUP_TEAMS.TEAM_ID%TYPE
    );

    PROCEDURE PR_CREATE_USER(
        P_FULL_NAME     IN TB_LEVELUP_USERS.FULL_NAME%TYPE,
        P_EMAIL         IN TB_LEVELUP_USERS.EMAIL%TYPE,
        P_PASSWORD_HASH IN TB_LEVELUP_USERS.PASSWORD_HASH%TYPE,
        P_JOB_TITLE     IN TB_LEVELUP_USERS.JOB_TITLE%TYPE,
        P_TEAM_ID       IN TB_LEVELUP_USERS.TEAM_ID%TYPE    DEFAULT NULL,
        P_ROLE          IN TB_LEVELUP_USERS.ROLE%TYPE       DEFAULT 'USER',
        P_USER_ID       OUT TB_LEVELUP_USERS.USER_ID%TYPE
    );

    PROCEDURE PR_CREATE_REWARD(
        P_NAME           IN TB_LEVELUP_REWARDS.NAME%TYPE,
        P_DESCRIPTION    IN TB_LEVELUP_REWARDS.DESCRIPTION%TYPE,
        P_POINT_COST     IN TB_LEVELUP_REWARDS.POINT_COST%TYPE,
        P_STOCK_QUANTITY IN TB_LEVELUP_REWARDS.STOCK_QUANTITY%TYPE,
        P_REWARD_ID      OUT TB_LEVELUP_REWARDS.REWARD_ID%TYPE
    );

    PROCEDURE PR_CREATE_TASK(
        P_TITLE        IN TB_LEVELUP_TASKS.TITLE%TYPE,
        P_DESCRIPTION  IN TB_LEVELUP_TASKS.DESCRIPTION%TYPE,
        P_POINTS_VALUE IN TB_LEVELUP_TASKS.POINTS_VALUE%TYPE,
        P_TASK_TYPE    IN TB_LEVELUP_TASKS.TASK_TYPE%TYPE,
        P_TASK_ID      OUT TB_LEVELUP_TASKS.TASK_ID%TYPE
    );

    PROCEDURE PR_CREATE_TASK_ASSIGNMENT(
        P_TASK_ID      IN TB_LEVELUP_TASK_ASSIGNMENTS.TASK_ID%TYPE,
        P_USER_ID      IN TB_LEVELUP_TASK_ASSIGNMENTS.USER_ID%TYPE,
        P_TEAM_ID      IN TB_LEVELUP_TASK_ASSIGNMENTS.TEAM_ID%TYPE,
        P_PERIOD_START IN TB_LEVELUP_TASK_ASSIGNMENTS.PERIOD_START%TYPE,
        P_PERIOD_END   IN TB_LEVELUP_TASK_ASSIGNMENTS.PERIOD_END%TYPE,
        P_IS_MANDATORY IN TB_LEVELUP_TASK_ASSIGNMENTS.IS_MANDATORY%TYPE,
        P_ASSIGNMENT_ID OUT TB_LEVELUP_TASK_ASSIGNMENTS.ASSIGNMENT_ID%TYPE
    );

    PROCEDURE PR_CREATE_TASK_COMPLETION(
        P_USER_ID IN TB_LEVELUP_TASK_COMPLETIONS.USER_ID%TYPE,
        P_TASK_ID IN TB_LEVELUP_TASK_COMPLETIONS.TASK_ID%TYPE,
        P_COMPLETION_ID OUT TB_LEVELUP_TASK_COMPLETIONS.COMPLETION_ID%TYPE
    );

    PROCEDURE PR_CREATE_REWARD_REDEMPTION(
        P_USER_ID      IN TB_LEVELUP_REWARD_REDEMPTIONS.USER_ID%TYPE,
        P_REWARD_ID    IN TB_LEVELUP_REWARD_REDEMPTIONS.REWARD_ID%TYPE,
        P_POINTS_SPENT IN TB_LEVELUP_REWARD_REDEMPTIONS.POINTS_SPENT%TYPE,
        P_REDEEMED_AT   IN TB_LEVELUP_REWARD_REDEMPTIONS.REDEEMED_AT%TYPE,
        P_REDEMPTION_ID OUT TB_LEVELUP_REWARD_REDEMPTIONS.REDEMPTION_ID%TYPE
    );

    PROCEDURE PR_WRITE_AUDIT(
        P_TABLE_NAME      IN TB_LEVELUP_AUDIT_LOGS.TABLE_NAME%TYPE,
        P_OPERATION_TYPE  IN TB_LEVELUP_AUDIT_LOGS.OPERATION_TYPE%TYPE,
        P_RECORD_PK_VALUE IN TB_LEVELUP_AUDIT_LOGS.RECORD_PK_VALUE%TYPE
    );

    FUNCTION FN_BUILD_USER_PROFILE_JSON(
        P_USER_ID IN TB_LEVELUP_USERS.USER_ID%TYPE
    ) RETURN CLOB;

    FUNCTION FN_ANALYZE_USER_FUTURE_PROFILE(
        P_USER_ID IN TB_LEVELUP_USERS.USER_ID%TYPE
    ) RETURN CLOB;

    PROCEDURE PR_EXPORT_USERS_DATASET(
        P_JSON OUT CLOB
    );

END PKG_LEVELUP_APP;
/

CREATE OR REPLACE PACKAGE BODY PKG_LEVELUP_APP AS

    
    FUNCTION CREATE_JSON(P_TEXT IN VARCHAR2) RETURN VARCHAR2 IS
    BEGIN
        IF P_TEXT IS NULL THEN
            RETURN '';
        ELSE
            RETURN REPLACE(P_TEXT, '"', '\"');
        END IF;
    END;

    PROCEDURE PR_CREATE_TEAM(
        P_TEAM_NAME IN TB_LEVELUP_TEAMS.TEAM_NAME%TYPE,
        P_TEAM_ID   OUT TB_LEVELUP_TEAMS.TEAM_ID%TYPE
    ) IS
    BEGIN
        INSERT INTO TB_LEVELUP_TEAMS (TEAM_NAME)
        VALUES (P_TEAM_NAME)
        RETURNING TEAM_ID INTO P_TEAM_ID;

    EXCEPTION
        WHEN DUP_VAL_ON_INDEX THEN
            DBMS_OUTPUT.PUT_LINE('Time já existe: ' || P_TEAM_NAME);
            RAISE;
        WHEN OTHERS THEN
            DBMS_OUTPUT.PUT_LINE('Erro ao criar time: ' || SQLERRM);
            RAISE;
    END PR_CREATE_TEAM;


    PROCEDURE PR_CREATE_USER(
        P_FULL_NAME     IN TB_LEVELUP_USERS.FULL_NAME%TYPE,
        P_EMAIL         IN TB_LEVELUP_USERS.EMAIL%TYPE,
        P_PASSWORD_HASH IN TB_LEVELUP_USERS.PASSWORD_HASH%TYPE,
        P_JOB_TITLE     IN TB_LEVELUP_USERS.JOB_TITLE%TYPE,
        P_TEAM_ID       IN TB_LEVELUP_USERS.TEAM_ID%TYPE,
        P_ROLE          IN TB_LEVELUP_USERS.ROLE%TYPE,
        P_USER_ID       OUT TB_LEVELUP_USERS.USER_ID%TYPE
    ) IS
    BEGIN
        -- Validação simples de formato de e-mail com REGEXP
        IF NOT REGEXP_LIKE(P_EMAIL,
                           '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$') THEN
            RAISE E_INVALID_EMAIL;
        END IF;

        INSERT INTO TB_LEVELUP_USERS (
            FULL_NAME, EMAIL, PASSWORD_HASH, JOB_TITLE,
            POINT_BALANCE, TEAM_ID, ROLE
        ) VALUES (
            P_FULL_NAME, P_EMAIL, P_PASSWORD_HASH, P_JOB_TITLE,
            0, P_TEAM_ID, NVL(P_ROLE, 'USER')
        )
        RETURNING USER_ID INTO P_USER_ID;

    EXCEPTION
        WHEN E_INVALID_EMAIL THEN
            DBMS_OUTPUT.PUT_LINE('E-mail inválido: ' || P_EMAIL);
            RAISE;
        WHEN DUP_VAL_ON_INDEX THEN
            DBMS_OUTPUT.PUT_LINE('E-mail já cadastrado: ' || P_EMAIL);
            RAISE;
        WHEN OTHERS THEN
            DBMS_OUTPUT.PUT_LINE('Erro ao criar usuário: ' || SQLERRM);
            RAISE;
    END PR_CREATE_USER;


    PROCEDURE PR_CREATE_REWARD(
        P_NAME           IN TB_LEVELUP_REWARDS.NAME%TYPE,
        P_DESCRIPTION    IN TB_LEVELUP_REWARDS.DESCRIPTION%TYPE,
        P_POINT_COST     IN TB_LEVELUP_REWARDS.POINT_COST%TYPE,
        P_STOCK_QUANTITY IN TB_LEVELUP_REWARDS.STOCK_QUANTITY%TYPE,
        P_REWARD_ID      OUT TB_LEVELUP_REWARDS.REWARD_ID%TYPE
    ) IS
    BEGIN
        INSERT INTO TB_LEVELUP_REWARDS (
            NAME, DESCRIPTION, POINT_COST, STOCK_QUANTITY
        ) VALUES (
            P_NAME, P_DESCRIPTION, P_POINT_COST, P_STOCK_QUANTITY
        )
        RETURNING REWARD_ID INTO P_REWARD_ID;

    EXCEPTION
        WHEN OTHERS THEN
            DBMS_OUTPUT.PUT_LINE('Erro ao criar recompensa: ' || SQLERRM);
            RAISE;
    END PR_CREATE_REWARD;


    PROCEDURE PR_CREATE_TASK(
        P_TITLE        IN TB_LEVELUP_TASKS.TITLE%TYPE,
        P_DESCRIPTION  IN TB_LEVELUP_TASKS.DESCRIPTION%TYPE,
        P_POINTS_VALUE IN TB_LEVELUP_TASKS.POINTS_VALUE%TYPE,
        P_TASK_TYPE    IN TB_LEVELUP_TASKS.TASK_TYPE%TYPE,
        P_TASK_ID      OUT TB_LEVELUP_TASKS.TASK_ID%TYPE
    ) IS
    BEGIN
        INSERT INTO TB_LEVELUP_TASKS (
            TITLE, DESCRIPTION, POINTS_VALUE, TASK_TYPE
        ) VALUES (
            P_TITLE, P_DESCRIPTION, P_POINTS_VALUE, P_TASK_TYPE
        )
        RETURNING TASK_ID INTO P_TASK_ID;

    EXCEPTION
        WHEN OTHERS THEN
            DBMS_OUTPUT.PUT_LINE('Erro ao criar tarefa: ' || SQLERRM);
            RAISE;
    END PR_CREATE_TASK;


    PROCEDURE PR_CREATE_TASK_ASSIGNMENT(
        P_TASK_ID      IN TB_LEVELUP_TASK_ASSIGNMENTS.TASK_ID%TYPE,
        P_USER_ID      IN TB_LEVELUP_TASK_ASSIGNMENTS.USER_ID%TYPE,
        P_TEAM_ID      IN TB_LEVELUP_TASK_ASSIGNMENTS.TEAM_ID%TYPE,
        P_PERIOD_START IN TB_LEVELUP_TASK_ASSIGNMENTS.PERIOD_START%TYPE,
        P_PERIOD_END   IN TB_LEVELUP_TASK_ASSIGNMENTS.PERIOD_END%TYPE,
        P_IS_MANDATORY IN TB_LEVELUP_TASK_ASSIGNMENTS.IS_MANDATORY%TYPE,
        P_ASSIGNMENT_ID OUT TB_LEVELUP_TASK_ASSIGNMENTS.ASSIGNMENT_ID%TYPE
    ) IS
    BEGIN
        INSERT INTO TB_LEVELUP_TASK_ASSIGNMENTS (
            TASK_ID, USER_ID, TEAM_ID,
            PERIOD_START, PERIOD_END, IS_MANDATORY
        ) VALUES (
            P_TASK_ID, P_USER_ID, P_TEAM_ID,
            P_PERIOD_START, P_PERIOD_END, P_IS_MANDATORY
        )
        RETURNING ASSIGNMENT_ID INTO P_ASSIGNMENT_ID;

    EXCEPTION
        WHEN OTHERS THEN
            DBMS_OUTPUT.PUT_LINE('Erro ao criar atribuição de tarefa: ' || SQLERRM);
            RAISE;
    END PR_CREATE_TASK_ASSIGNMENT;


    PROCEDURE PR_CREATE_TASK_COMPLETION(
        P_USER_ID IN TB_LEVELUP_TASK_COMPLETIONS.USER_ID%TYPE,
        P_TASK_ID IN TB_LEVELUP_TASK_COMPLETIONS.TASK_ID%TYPE,
        P_COMPLETION_ID OUT TB_LEVELUP_TASK_COMPLETIONS.COMPLETION_ID%TYPE
    ) IS
    BEGIN
        INSERT INTO TB_LEVELUP_TASK_COMPLETIONS (
            USER_ID, TASK_ID
        ) VALUES (
            P_USER_ID, P_TASK_ID
        )
        RETURNING COMPLETION_ID INTO P_COMPLETION_ID;

        UPDATE TB_LEVELUP_USERS U
           SET U.POINT_BALANCE = U.POINT_BALANCE +
               (SELECT T.POINTS_VALUE
                  FROM TB_LEVELUP_TASKS T
                 WHERE T.TASK_ID = P_TASK_ID)
         WHERE U.USER_ID = P_USER_ID;

    EXCEPTION
        WHEN DUP_VAL_ON_INDEX THEN
            DBMS_OUTPUT.PUT_LINE('Usuário já concluiu essa tarefa uma vez.');
            RAISE;
        WHEN OTHERS THEN
            DBMS_OUTPUT.PUT_LINE('Erro ao registrar conclusão de tarefa: ' || SQLERRM);
            RAISE;
    END PR_CREATE_TASK_COMPLETION;

PROCEDURE PR_CREATE_REWARD_REDEMPTION(
        P_USER_ID      IN TB_LEVELUP_REWARD_REDEMPTIONS.USER_ID%TYPE,
        P_REWARD_ID    IN TB_LEVELUP_REWARD_REDEMPTIONS.REWARD_ID%TYPE,
        P_POINTS_SPENT IN TB_LEVELUP_REWARD_REDEMPTIONS.POINTS_SPENT%TYPE,
        P_REDEEMED_AT   IN TB_LEVELUP_REWARD_REDEMPTIONS.REDEEMED_AT%TYPE,
        P_REDEMPTION_ID OUT TB_LEVELUP_REWARD_REDEMPTIONS.REDEMPTION_ID%TYPE
    ) IS
        V_BALANCE TB_LEVELUP_USERS.POINT_BALANCE%TYPE;
        V_COST    TB_LEVELUP_REWARDS.POINT_COST%TYPE;
    BEGIN

        SELECT POINT_BALANCE
          INTO V_BALANCE
          FROM TB_LEVELUP_USERS
         WHERE USER_ID = P_USER_ID
         FOR UPDATE;

        SELECT POINT_COST
          INTO V_COST
          FROM TB_LEVELUP_REWARDS
         WHERE REWARD_ID = P_REWARD_ID
         FOR UPDATE;

        IF P_POINTS_SPENT IS NOT NULL AND P_POINTS_SPENT <> V_COST THEN
            RAISE_APPLICATION_ERROR(
                -20002,
                'Valor de pontos inválido para essa recompensa. Deve ser igual ao point_cost.'
            );
        END IF;

        IF V_BALANCE < V_COST THEN
            RAISE_APPLICATION_ERROR(-20001, 'Saldo insuficiente de pontos para esta recompensa.');
        END IF;

        INSERT INTO TB_LEVELUP_REWARD_REDEMPTIONS (
            USER_ID, REWARD_ID, POINTS_SPENT
        ) VALUES (
            P_USER_ID, P_REWARD_ID, V_COST
        )
        RETURNING REDEMPTION_ID INTO P_REDEMPTION_ID;

        UPDATE TB_LEVELUP_USERS
           SET POINT_BALANCE = POINT_BALANCE - V_COST
         WHERE USER_ID = P_USER_ID;

        UPDATE TB_LEVELUP_REWARDS
           SET STOCK_QUANTITY = STOCK_QUANTITY - 1
         WHERE REWARD_ID = P_REWARD_ID;

    EXCEPTION
        WHEN OTHERS THEN
            DBMS_OUTPUT.PUT_LINE('Erro ao registrar resgate: ' || SQLERRM);
            RAISE;
    END PR_CREATE_REWARD_REDEMPTION;


    PROCEDURE PR_WRITE_AUDIT(
        P_TABLE_NAME      IN TB_LEVELUP_AUDIT_LOGS.TABLE_NAME%TYPE,
        P_OPERATION_TYPE  IN TB_LEVELUP_AUDIT_LOGS.OPERATION_TYPE%TYPE,
        P_RECORD_PK_VALUE IN TB_LEVELUP_AUDIT_LOGS.RECORD_PK_VALUE%TYPE
    ) IS
    BEGIN
        INSERT INTO TB_LEVELUP_AUDIT_LOGS (
            TABLE_NAME, OPERATION_TYPE, RECORD_PK_VALUE
        ) VALUES (
            P_TABLE_NAME, P_OPERATION_TYPE, P_RECORD_PK_VALUE
        );
    EXCEPTION
        WHEN OTHERS THEN
            DBMS_OUTPUT.PUT_LINE('Erro: ' || SQLERRM);
    END PR_WRITE_AUDIT;


    FUNCTION FN_BUILD_USER_PROFILE_JSON(
        P_USER_ID IN TB_LEVELUP_USERS.USER_ID%TYPE
    ) RETURN CLOB IS

        V_FULL_NAME     TB_LEVELUP_USERS.FULL_NAME%TYPE;
        V_EMAIL         TB_LEVELUP_USERS.EMAIL%TYPE;
        V_JOB_TITLE     TB_LEVELUP_USERS.JOB_TITLE%TYPE;
        V_POINT_BALANCE TB_LEVELUP_USERS.POINT_BALANCE%TYPE;

        V_JSON   CLOB;
        V_FIRST  BOOLEAN;

        CURSOR C_TASKS IS
            SELECT T.TITLE,
                   T.TASK_TYPE,
                   C.COMPLETED_AT
              FROM TB_LEVELUP_TASK_COMPLETIONS C
              JOIN TB_LEVELUP_TASKS T
                ON T.TASK_ID = C.TASK_ID
             WHERE C.USER_ID = P_USER_ID
             ORDER BY C.COMPLETED_AT DESC;

        CURSOR C_REWARDS IS
            SELECT R.NAME,
                   RR.POINTS_SPENT,
                   RR.REDEEMED_AT
              FROM TB_LEVELUP_REWARD_REDEMPTIONS RR
              JOIN TB_LEVELUP_REWARDS R
                ON R.REWARD_ID = RR.REWARD_ID
             WHERE RR.USER_ID = P_USER_ID
             ORDER BY RR.REDEEMED_AT DESC;

        V_TASK_COUNT   PLS_INTEGER := 0;
        V_REWARD_COUNT PLS_INTEGER := 0;

    BEGIN

        BEGIN
            SELECT FULL_NAME, EMAIL, JOB_TITLE, POINT_BALANCE
              INTO V_FULL_NAME, V_EMAIL, V_JOB_TITLE, V_POINT_BALANCE
              FROM TB_LEVELUP_USERS
             WHERE USER_ID = P_USER_ID;
        EXCEPTION
            WHEN NO_DATA_FOUND THEN
                RAISE E_USER_NOT_FOUND;
        END;

        V_JSON := '{' ||
                  '"user_id": ' || P_USER_ID || ',' ||
                  '"full_name": "' || CREATE_JSON(V_FULL_NAME) || '",' ||
                  '"email": "' || CREATE_JSON(V_EMAIL) || '",' ||
                  '"job_title": "' || CREATE_JSON(V_JOB_TITLE) || '",' ||
                  '"point_balance": ' || NVL(V_POINT_BALANCE,0) || ',';

        V_JSON := V_JSON || '"completed_tasks": [';

        V_FIRST := TRUE;
        FOR REC IN C_TASKS LOOP
            V_TASK_COUNT := V_TASK_COUNT + 1;
            IF NOT V_FIRST THEN
                V_JSON := V_JSON || ',';
            ELSE
                V_FIRST := FALSE;
            END IF;

            V_JSON := V_JSON ||
                      '{' ||
                      '"title": "' || CREATE_JSON(REC.TITLE) || '",' ||
                      '"task_type": "' || CREATE_JSON(REC.TASK_TYPE) || '",' ||
                      '"completed_at": "' || TO_CHAR(REC.COMPLETED_AT, 'YYYY-MM-DD"T"HH24:MI:SS') || '"' ||
                      '}';
        END LOOP;

        V_JSON := V_JSON || '],';

        V_JSON := V_JSON || '"reward_redemptions": [';

        V_FIRST := TRUE;
        FOR REC2 IN C_REWARDS LOOP
            V_REWARD_COUNT := V_REWARD_COUNT + 1;
            IF NOT V_FIRST THEN
                V_JSON := V_JSON || ',';
            ELSE
                V_FIRST := FALSE;
            END IF;

            V_JSON := V_JSON ||
                      '{' ||
                      '"reward_name": "' || CREATE_JSON(REC2.NAME) || '",' ||
                      '"points_spent": ' || REC2.POINTS_SPENT || ',' ||
                      '"redeemed_at": "' || TO_CHAR(REC2.REDEEMED_AT, 'YYYY-MM-DD"T"HH24:MI:SS') || '"' ||
                      '}';
        END LOOP;

        V_JSON := V_JSON || ']';

        IF V_TASK_COUNT = 0 AND V_REWARD_COUNT = 0 THEN
            RAISE E_NO_DATA_FOR_JSON;
        END IF;

        V_JSON := V_JSON || '}';

        RETURN V_JSON;

    EXCEPTION
        WHEN E_USER_NOT_FOUND THEN
            DBMS_OUTPUT.PUT_LINE('fn_build_user_profile_json: usuário não encontrado: ' || P_USER_ID);
            PR_WRITE_AUDIT('JSON_EXPORT', 'INSERT',
                           'USER_ID=' || P_USER_ID || ' NÃO_ENCONTRADO');
            RETURN '{"error": "usuario_nao_encontrado", "user_id": ' || P_USER_ID || '}';

        WHEN E_NO_DATA_FOR_JSON THEN
            DBMS_OUTPUT.PUT_LINE('fn_build_user_profile_json: usuário sem dados para JSON: ' || P_USER_ID);
            PR_WRITE_AUDIT('JSON_EXPORT', 'INSERT',
                           'USER_ID=' || P_USER_ID || ' SEM_DADOS');
            RETURN '{"error": "sem_dados_para_json", "user_id": ' || P_USER_ID || '}';

        WHEN OTHERS THEN
            DBMS_OUTPUT.PUT_LINE('fn_build_user_profile_json: erro: ' || SQLERRM);
            PR_WRITE_AUDIT('JSON_EXPORT', 'INSERT',
                           'USER_ID=' || P_USER_ID || ' ERRO=' || SQLERRM);
            RETURN '{"error": "erro_interno", "user_id": ' || P_USER_ID || '}';
    END FN_BUILD_USER_PROFILE_JSON;

        FUNCTION FN_ANALYZE_USER_FUTURE_PROFILE(
        P_USER_ID IN TB_LEVELUP_USERS.USER_ID%TYPE
    ) RETURN CLOB IS

        V_FULL_NAME TB_LEVELUP_USERS.FULL_NAME%TYPE;
        V_EMAIL     TB_LEVELUP_USERS.EMAIL%TYPE;

        V_EMAIL_OK        BOOLEAN := FALSE;
        V_EMAIL_CORPORATE BOOLEAN := FALSE;

        V_TASKS_COMPLETED   NUMBER := 0;
        V_TOTAL_POINTS      NUMBER := 0;
        V_AVG_POINTS        NUMBER := 0;
        V_ENGAGEMENT_LEVEL  VARCHAR2(20);

        V_JSON  CLOB;
    BEGIN

        SELECT FULL_NAME,
               EMAIL
          INTO V_FULL_NAME,
               V_EMAIL
          FROM TB_LEVELUP_USERS
         WHERE USER_ID = P_USER_ID;

        IF REGEXP_LIKE(
               V_EMAIL,
               '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$',
               'i'
           ) THEN
            V_EMAIL_OK := TRUE;
        END IF;

        IF NOT REGEXP_LIKE(
               V_EMAIL,
               '@(gmail\.com|yahoo\.com|hotmail\.com|outlook\.com)$',
               'i'
           ) THEN
            V_EMAIL_CORPORATE := TRUE;
        END IF;

        SELECT COUNT(*),
               NVL(SUM(T.POINTS_VALUE), 0),
               NVL(AVG(T.POINTS_VALUE), 0)
          INTO V_TASKS_COMPLETED,
               V_TOTAL_POINTS,
               V_AVG_POINTS
          FROM TB_LEVELUP_TASK_COMPLETIONS C
          JOIN TB_LEVELUP_TASKS T
            ON T.TASK_ID = C.TASK_ID
         WHERE C.USER_ID = P_USER_ID;

        IF V_TASKS_COMPLETED = 0 THEN
            V_ENGAGEMENT_LEVEL := 'INATIVO';
        ELSIF V_TASKS_COMPLETED <= 3 THEN
            V_ENGAGEMENT_LEVEL := 'BAIXO';
        ELSIF V_TASKS_COMPLETED <= 7 THEN
            V_ENGAGEMENT_LEVEL := 'MEDIO';
        ELSE
            V_ENGAGEMENT_LEVEL := 'ALTO';
        END IF;

        V_JSON := '{' ||
                  '"user_id": ' || P_USER_ID || ',' ||
                  '"full_name": "' || CREATE_JSON(V_FULL_NAME) || '",' ||
                  '"email": "' || CREATE_JSON(V_EMAIL) || '",' ||
                  '"email_format_ok": ' ||
                      CASE WHEN V_EMAIL_OK THEN 'true' ELSE 'false' END || ',' ||
                  '"email_is_corporate": ' ||
                      CASE WHEN V_EMAIL_CORPORATE THEN 'true' ELSE 'false' END || ',' ||
                  '"tasks_completed": ' || V_TASKS_COMPLETED || ',' ||
                  '"total_points_earned": ' || V_TOTAL_POINTS || ',' ||
                  '"avg_points_per_task": ' ||
                      TO_CHAR(NVL(V_AVG_POINTS, 0), 'FM9999990.00') || ',' ||
                  '"engagement_level": "' || V_ENGAGEMENT_LEVEL || '"' ||
                  '}';

        RETURN V_JSON;

    EXCEPTION
        WHEN NO_DATA_FOUND THEN
            DBMS_OUTPUT.PUT_LINE(
                'fn_analyze_user_future_profile: usuário não encontrado: ' || P_USER_ID
            );
            RETURN '{"error": "usuario_nao_encontrado", "user_id": ' || P_USER_ID || '}';

        WHEN OTHERS THEN
            DBMS_OUTPUT.PUT_LINE(
                'fn_analyze_user_Future_profile: erro inesperado: ' || SQLERRM
            );
            RETURN '{"error": "erro_interno", "user_id": ' || P_USER_ID || '}';
    END FN_ANALYZE_USER_FUTURE_PROFILE; 

    PROCEDURE PR_EXPORT_USERS_DATASET(
        P_JSON OUT CLOB
    ) IS
        CURSOR C_USERS IS
            SELECT USER_ID
              FROM TB_LEVELUP_USERS
             WHERE IS_ACTIVE = 'Y';

        V_FIRST   BOOLEAN := TRUE;
        V_PROFILE CLOB;
    BEGIN
        P_JSON := '[';

        FOR U IN C_USERS LOOP
            V_PROFILE := FN_BUILD_USER_PROFILE_JSON(U.USER_ID);

            IF NOT V_FIRST THEN
                P_JSON := P_JSON || ',';
            ELSE
                V_FIRST := FALSE;
            END IF;

            P_JSON := P_JSON || V_PROFILE;
        END LOOP;

        P_JSON := P_JSON || ']';

    EXCEPTION
        WHEN OTHERS THEN
            DBMS_OUTPUT.PUT_LINE('pr_export_users_dataset: erro ao exportar JSON: ' || SQLERRM);
            P_JSON := '[]';
    END PR_EXPORT_USERS_DATASET;

END PKG_LEVELUP_APP;
/


CREATE OR REPLACE TRIGGER TR_AUDIT_USERS
AFTER INSERT OR UPDATE OR DELETE ON TB_LEVELUP_USERS
FOR EACH ROW
BEGIN
    IF INSERTING THEN
        PKG_LEVELUP_APP.PR_WRITE_AUDIT('TB_LEVELUP_USERS', 'INSERT', TO_CHAR(:NEW.USER_ID));
    ELSIF UPDATING THEN
        PKG_LEVELUP_APP.PR_WRITE_AUDIT('TB_LEVELUP_USERS', 'UPDATE', TO_CHAR(:NEW.USER_ID));
    ELSIF DELETING THEN
        PKG_LEVELUP_APP.PR_WRITE_AUDIT('TB_LEVELUP_USERS', 'DELETE', TO_CHAR(:OLD.USER_ID));
    END IF;
END;
/

CREATE OR REPLACE TRIGGER TR_AUDIT_TEAMS
AFTER INSERT OR UPDATE OR DELETE ON TB_LEVELUP_TEAMS
FOR EACH ROW
BEGIN
    IF INSERTING THEN
        PKG_LEVELUP_APP.PR_WRITE_AUDIT('TB_LEVELUP_TEAMS', 'INSERT', TO_CHAR(:NEW.TEAM_ID));
    ELSIF UPDATING THEN
        PKG_LEVELUP_APP.PR_WRITE_AUDIT('TB_LEVELUP_TEAMS', 'UPDATE', TO_CHAR(:NEW.TEAM_ID));
    ELSIF DELETING THEN
        PKG_LEVELUP_APP.PR_WRITE_AUDIT('TB_LEVELUP_TEAMS', 'DELETE', TO_CHAR(:OLD.TEAM_ID));
    END IF;
END;
/

CREATE OR REPLACE TRIGGER TR_AUDIT_REWARDS
AFTER INSERT OR UPDATE OR DELETE ON TB_LEVELUP_REWARDS
FOR EACH ROW
BEGIN
    IF INSERTING THEN
        PKG_LEVELUP_APP.PR_WRITE_AUDIT('TB_LEVELUP_REWARDS', 'INSERT', TO_CHAR(:NEW.REWARD_ID));
    ELSIF UPDATING THEN
        PKG_LEVELUP_APP.PR_WRITE_AUDIT('TB_LEVELUP_REWARDS', 'UPDATE', TO_CHAR(:NEW.REWARD_ID));
    ELSIF DELETING THEN
        PKG_LEVELUP_APP.PR_WRITE_AUDIT('TB_LEVELUP_REWARDS', 'DELETE', TO_CHAR(:OLD.REWARD_ID));
    END IF;
END;
/

CREATE OR REPLACE TRIGGER TR_AUDIT_TASKS
AFTER INSERT OR UPDATE OR DELETE ON TB_LEVELUP_TASKS
FOR EACH ROW
BEGIN
    IF INSERTING THEN
        PKG_LEVELUP_APP.PR_WRITE_AUDIT('TB_LEVELUP_TASKS', 'INSERT', TO_CHAR(:NEW.TASK_ID));
    ELSIF UPDATING THEN
        PKG_LEVELUP_APP.PR_WRITE_AUDIT('TB_LEVELUP_TASKS', 'UPDATE', TO_CHAR(:NEW.TASK_ID));
    ELSIF DELETING THEN
        PKG_LEVELUP_APP.PR_WRITE_AUDIT('TB_LEVELUP_TASKS', 'DELETE', TO_CHAR(:OLD.TASK_ID));
    END IF;
END;
/

CREATE OR REPLACE TRIGGER TR_AUDIT_TASK_ASSIGN
AFTER INSERT OR UPDATE OR DELETE ON TB_LEVELUP_TASK_ASSIGNMENTS
FOR EACH ROW
BEGIN
    IF INSERTING THEN
        PKG_LEVELUP_APP.PR_WRITE_AUDIT('TB_LEVELUP_TASK_ASSIGNMENTS', 'INSERT', TO_CHAR(:NEW.ASSIGNMENT_ID));
    ELSIF UPDATING THEN
        PKG_LEVELUP_APP.PR_WRITE_AUDIT('TB_LEVELUP_TASK_ASSIGNMENTS', 'UPDATE', TO_CHAR(:NEW.ASSIGNMENT_ID));
    ELSIF DELETING THEN
        PKG_LEVELUP_APP.PR_WRITE_AUDIT('TB_LEVELUP_TASK_ASSIGNMENTS', 'DELETE', TO_CHAR(:OLD.ASSIGNMENT_ID));
    END IF;
END;
/

CREATE OR REPLACE TRIGGER TR_AUDIT_TASK_COMPLETIONS
AFTER INSERT OR UPDATE OR DELETE ON TB_LEVELUP_TASK_COMPLETIONS
FOR EACH ROW
BEGIN
    IF INSERTING THEN
        PKG_LEVELUP_APP.PR_WRITE_AUDIT('TB_LEVELUP_TASK_COMPLETIONS', 'INSERT', TO_CHAR(:NEW.COMPLETION_ID));
    ELSIF UPDATING THEN
        PKG_LEVELUP_APP.PR_WRITE_AUDIT('TB_LEVELUP_TASK_COMPLETIONS', 'UPDATE', TO_CHAR(:NEW.COMPLETION_ID));
    ELSIF DELETING THEN
        PKG_LEVELUP_APP.PR_WRITE_AUDIT('TB_LEVELUP_TASK_COMPLETIONS', 'DELETE', TO_CHAR(:OLD.COMPLETION_ID));
    END IF;
END;
/

CREATE OR REPLACE TRIGGER TR_AUDIT_REWARD_REDEMPTIONS
AFTER INSERT OR UPDATE OR DELETE ON TB_LEVELUP_REWARD_REDEMPTIONS
FOR EACH ROW
BEGIN
    IF INSERTING THEN
        PKG_LEVELUP_APP.PR_WRITE_AUDIT('TB_LEVELUP_REWARD_REDEMPTIONS', 'INSERT', TO_CHAR(:NEW.REDEMPTION_ID));
    ELSIF UPDATING THEN
        PKG_LEVELUP_APP.PR_WRITE_AUDIT('TB_LEVELUP_REWARD_REDEMPTIONS', 'UPDATE', TO_CHAR(:NEW.REDEMPTION_ID));
    ELSIF DELETING THEN
        PKG_LEVELUP_APP.PR_WRITE_AUDIT('TB_LEVELUP_REWARD_REDEMPTIONS', 'DELETE', TO_CHAR(:OLD.REDEMPTION_ID));
    END IF;
END;
/
